<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ポケポケ 勝敗記録</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f6fb;
    }
    header {
      background: #2563eb;
      color: white;
      padding: 12px 16px;
      font-size: 20px;
      font-weight: bold;
    }
    main {
      padding: 12px 16px 40px;
      max-width: 900px;
      margin: 0 auto;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 12px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .card h2 {
      margin: 0 0 6px;
      font-size: 16px;
    }
    .card small {
      color: #6b7280;
    }
    label {
      font-size: 13px;
      display: block;
      margin: 6px 0 2px;
    }
    input[type="text"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
    }
    textarea {
      min-height: 50px;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      cursor: pointer;
    }
    .btn-main {
      background: #2563eb;
      color: white;
    }
    .btn-sub {
      background: #e5e7eb;
      color: #374151;
    }
    .row {
      display: flex;
      gap: 8px;
    }
    .row > div {
      flex: 1;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 4px 6px;
      text-align: left;
    }
    th {
      background: #f3f4f6;
    }
    .tag-win {
      color: #1d4ed8;
      font-weight: bold;
    }
    .tag-lose {
      color: #b91c1c;
      font-weight: bold;
    }
    .tag-draw {
      color: #6b7280;
      font-weight: bold;
    }
    .tag-order {
      font-size: 11px;
      padding: 1px 6px;
      border-radius: 999px;
      background: #e5e7eb;
      margin-left: 4px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
      font-size: 13px;
    }
    .stat-box {
      padding: 6px 8px;
      border-radius: 10px;
      background: #eff6ff;
    }
    .stat-title {
      font-size: 12px;
      color: #4b5563;
    }
    .stat-main {
      font-size: 16px;
      font-weight: bold;
    }
    .stat-sub {
      font-size: 12px;
      color: #6b7280;
    }
    .muted {
      color: #6b7280;
      font-size: 12px;
    }
    .type-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 4px;
      vertical-align: middle;
    }
    .type-label {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e5e7eb;
      margin-left: 2px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
<header>
  ポケポケ 勝敗記録（Web版）
</header>

<main>
  <!-- 入力フォーム -->
  <section class="card">
    <h2>対戦を記録</h2>
    <div class="row">
      <div>
        <label>日付</label>
        <input type="date" id="dateInput">
      </div>
      <div>
        <label>自分のデッキ</label>
        <input type="text" id="myDeckInput" placeholder="例）エビワラー" />
      </div>
    </div>

    <label>相手のデッキ</label>
    <input type="text" id="opponentDeckInput" placeholder="例）水デッキ" />

    <div class="row">
      <div>
        <label>属性</label>
        <select id="typeInput">
          <option value="">（なし）</option>
          <option value="fire">炎</option>
          <option value="water">水</option>
          <option value="grass">草</option>
          <option value="lightning">雷</option>
          <option value="psychic">超</option>
          <option value="darkness">悪</option>
          <option value="fighting">闘</option>
          <option value="metal">鋼</option>
          <option value="colorless">無色</option>
        </select>
      </div>
      <div>
        <label>結果</label>
        <select id="resultInput">
          <option value="win">勝ち</option>
          <option value="lose">負け</option>
          <option value="draw">引き分け</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>先攻 / 後攻</label>
        <select id="orderInput">
          <option value="first">先攻</option>
          <option value="second">後攻</option>
        </select>
      </div>
    </div>

    <label>メモ</label>
    <textarea id="memoInput" placeholder="例）サイド差2枚で押し切り、事故、じゃんけん負けなど"></textarea>

    <div style="margin-top:8px; display:flex; gap:8px; justify-content:flex-end;">
      <button class="btn-sub" type="button" onclick="clearForm()">リセット</button>
      <button class="btn-main" type="button" onclick="addRecord()">記録を追加</button>
    </div>
    <p class="muted">※ ブラウザの中に自動保存されます（localStorage使用）。</p>
  </section>

  <!-- 成績サマリ -->
  <section class="card">
    <h2>成績サマリー</h2>
    <div class="stats-grid">
      <div class="stat-box">
        <div class="stat-title">トータル</div>
        <div class="stat-main" id="totalText">0戦</div>
        <div class="stat-sub" id="wlText">勝0 / 負0 / 分0</div>
      </div>
      <div class="stat-box">
        <div class="stat-title">総合勝率（引き分け除く）</div>
        <div class="stat-main" id="winRateText">0.0%</div>
        <div class="stat-sub">（勝 / （勝+負））</div>
      </div>
      <div class="stat-box">
        <div class="stat-title">先攻 勝率</div>
        <div class="stat-main" id="firstRateText">0.0%</div>
        <div class="stat-sub" id="firstDetailText">0勝 0敗</div>
      </div>
      <div class="stat-box">
        <div class="stat-title">後攻 勝率</div>
        <div class="stat-main" id="secondRateText">0.0%</div>
        <div class="stat-sub" id="secondDetailText">0勝 0敗</div>
      </div>
    </div>
  </section>

  <!-- 対戦一覧 -->
  <section class="card">
    <h2>対戦履歴</h2>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
      <small id="countText">0件</small>
      <button class="btn-sub" type="button" onclick="clearAll()" style="font-size:11px;">全消去</button>
    </div>
    <div style="overflow-x:auto;">
      <table id="recordsTable">
        <thead>
          <tr>
            <th>日付</th>
            <th>デッキ</th>
            <th>相手</th>
            <th>結果</th>
            <th>メモ</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <!-- JSで追加 -->
        </tbody>
      </table>
    </div>
  </section>
</main>

<script>
  // ------------ データ管理 ------------
  let records = [];

  function loadData() {
    const raw = localStorage.getItem("pokepokeRecords");
    if (raw) {
      try {
        records = JSON.parse(raw);
      } catch (e) {
        records = [];
      }
    }
  }

  function saveData() {
    localStorage.setItem("pokepokeRecords", JSON.stringify(records));
  }

  // ------------ ユーティリティ ------------
  function formatDate(iso) {
    if (!iso) return "";
    const d = new Date(iso);
    if (isNaN(d.getTime())) return iso;
    const y = d.getFullYear();
    const m = ("0" + (d.getMonth() + 1)).slice(-2);
    const day = ("0" + d.getDate()).slice(-2);
    return `${y}/${m}/${day}`;
  }

  function resultLabel(r) {
    if (r === "win") return "勝ち";
    if (r === "lose") return "負け";
    if (r === "draw") return "引き分け";
    return "";
  }

  function orderLabel(o) {
    if (o === "first") return "先攻";
    if (o === "second") return "後攻";
    return "";
  }

  function resultClass(r) {
    if (r === "win") return "tag-win";
    if (r === "lose") return "tag-lose";
    return "tag-draw";
  }

  // 属性表示用
  function typeLabel(t) {
    switch (t) {
      case "fire": return "炎";
      case "water": return "水";
      case "grass": return "草";
      case "lightning": return "雷";
      case "psychic": return "超";
      case "darkness": return "悪";
      case "fighting": return "闘";
      case "metal": return "鋼";
      case "colorless": return "無色";
      default: return "";
    }
  }

  function typeIconSrc(t) {
    if (!t) return null;
    return "icons/" + t + ".png";  // icons/fire.png など
  }

  // ------------ 追加 ------------
  function addRecord() {
    const date = document.getElementById("dateInput").value;
    const myDeck = document.getElementById("myDeckInput").value.trim();
    const opponentDeck = document.getElementById("opponentDeckInput").value.trim();
    const type = document.getElementById("typeInput").value;
    const result = document.getElementById("resultInput").value;
    const order = document.getElementById("orderInput").value;
    const memo = document.getElementById("memoInput").value.trim();

    if (!myDeck) {
      alert("自分のデッキ名を入力してください。");
      return;
    }

    const rec = {
      id: Date.now(),
      date,
      myDeck,
      opponentDeck,
      type,
      result,
      order,
      memo
    };

    records.push(rec);
    saveData();
    render();
    clearForm();
  }

  function clearForm() {
    const today = new Date().toISOString().slice(0,10);
    document.getElementById("dateInput").value = today;
    document.getElementById("myDeckInput").value = "";
    document.getElementById("opponentDeckInput").value = "";
    document.getElementById("typeInput").value = "";
    document.getElementById("resultInput").value = "win";
    document.getElementById("orderInput").value = "first";
    document.getElementById("memoInput").value = "";
  }

  function deleteRecord(id) {
    if (!confirm("この記録を削除しますか？")) return;
    records = records.filter(r => r.id !== id);
    saveData();
    render();
  }

  function clearAll() {
    if (!confirm("すべての記録を削除しますか？")) return;
    records = [];
    saveData();
    render();
  }

  // ------------ 表示 ------------
  function renderTable() {
    const tbody = document.querySelector("#recordsTable tbody");
    tbody.innerHTML = "";

    records
      .slice()
      .sort((a,b) => (a.date || "") < (b.date || "") ? 1 : -1) // 新しい順
      .forEach(rec => {
        const tr = document.createElement("tr");

        const tdDate = document.createElement("td");
        tdDate.textContent = formatDate(rec.date);

        const tdMy = document.createElement("td");
        // アイコン＋デッキ名
        const spanDeck = document.createElement("span");
        const tSrc = typeIconSrc(rec.type);
        if (tSrc) {
          const img = document.createElement("img");
          img.src = tSrc;
          img.alt = typeLabel(rec.type);
          img.className = "type-icon";
          spanDeck.appendChild(img);
        }
        const txt = document.createTextNode(rec.myDeck || "");
        spanDeck.appendChild(txt);

        const tLbl = typeLabel(rec.type);
        if (tLbl) {
          const spanType = document.createElement("span");
          spanType.className = "type-label";
          spanType.textContent = tLbl;
          spanDeck.appendChild(spanType);
        }

        tdMy.appendChild(spanDeck);

        const tdOpp = document.createElement("td");
        tdOpp.textContent = rec.opponentDeck;

        const tdRes = document.createElement("td");
        const spanR = document.createElement("span");
        spanR.textContent = resultLabel(rec.result);
        spanR.className = resultClass(rec.result);
        const spanO = document.createElement("span");
        spanO.textContent = orderLabel(rec.order);
        spanO.className = "tag-order";
        tdRes.appendChild(spanR);
        tdRes.appendChild(spanO);

        const tdMemo = document.createElement("td");
        tdMemo.textContent = rec.memo;

        const tdDel = document.createElement("td");
        const btn = document.createElement("button");
        btn.textContent = "削除";
        btn.className = "btn-sub";
        btn.style.fontSize = "11px";
        btn.onclick = () => deleteRecord(rec.id);
        tdDel.appendChild(btn);

        tr.appendChild(tdDate);
        tr.appendChild(tdMy);
        tr.appendChild(tdOpp);
        tr.appendChild(tdRes);
        tr.appendChild(tdMemo);
        tr.appendChild(tdDel);

        tbody.appendChild(tr);
      });

    document.getElementById("countText").textContent = `${records.length}件`;
  }

  function renderStats() {
    const wins = records.filter(r => r.result === "win").length;
    const loses = records.filter(r => r.result === "lose").length;
    const draws = records.filter(r => r.result === "draw").length;
    const total = records.length;

    const battle = wins + loses;
    const winRate = battle === 0 ? 0 : wins / battle * 100;

    document.getElementById("totalText").textContent = `${total}戦`;
    document.getElementById("wlText").textContent = `勝${wins} / 負${loses} / 分${draws}`;
    document.getElementById("winRateText").textContent = winRate.toFixed(1) + "%";

    const first = records.filter(r => r.order === "first");
    const second = records.filter(r => r.order === "second");

    const fW = first.filter(r => r.result === "win").length;
    const fL = first.filter(r => r.result === "lose").length;
    const sW = second.filter(r => r.result === "win").length;
    const sL = second.filter(r => r.result === "lose").length;

    const fTotal = fW + fL;
    const sTotal = sW + sL;

    const fRate = fTotal === 0 ? 0 : fW / fTotal * 100;
    const sRate = sTotal === 0 ? 0 : sW / sTotal * 100;

    document.getElementById("firstRateText").textContent = fRate.toFixed(1) + "%";
    document.getElementById("firstDetailText").textContent = `${fW}勝 ${fL}敗`;

    document.getElementById("secondRateText").textContent = sRate.toFixed(1) + "%";
    document.getElementById("secondDetailText").textContent = `${sW}勝 ${sL}敗`;
  }

  function render() {
    renderTable();
    renderStats();
  }

  // 初期化
  loadData();
  window.addEventListener("load", () => {
    clearForm();
    render();
  });
</script>
</body>
</html>
