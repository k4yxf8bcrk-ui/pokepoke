<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ポケポケ 勝敗記録</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js（スランプグラフ用） -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f6fb;
      color: #111827;
    }

    header {
      background: #2563eb;
      color: white;
      padding: 12px 16px;
      font-size: 18px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header .subtitle {
      font-size: 12px;
      font-weight: 400;
      opacity: 0.9;
    }

    main {
      padding: 12px 16px 40px;
      max-width: 1000px;
      margin: 0 auto;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 12px;
    }

    @media (max-width: 800px) {
      .grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
      box-sizing: border-box;
    }

    .card h2 {
      font-size: 16px;
      margin: 0 0 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card h2 span.badge {
      font-size: 11px;
      background: #e5edff;
      color: #1d4ed8;
      padding: 2px 6px;
      border-radius: 999px;
    }

    .card p.desc {
      margin: 0 0 8px;
      font-size: 11px;
      color: #6b7280;
    }

    .form-row {
      display: flex;
      flex-direction: column;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .form-row label {
      margin-bottom: 2px;
      font-weight: 500;
    }

    .form-row input,
    .form-row select,
    .form-row textarea {
      border-radius: 8px;
      border: 1px solid #d1d5db;
      padding: 6px 8px;
      font-size: 13px;
      font-family: inherit;
      box-sizing: border-box;
    }

    .form-row textarea {
      min-height: 50px;
      resize: vertical;
    }

    .inline-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .inline-option {
      display: flex;
      align-items: center;
      gap: 3px;
      font-size: 13px;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      background: #2563eb;
      color: white;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }

    button.danger {
      background: #ef4444;
      color: white;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .summary-label {
      color: #4b5563;
    }

    .summary-value {
      font-weight: 600;
    }

    .summary-highlight {
      font-size: 20px;
      font-weight: 700;
    }

    .summary-sub {
      font-size: 11px;
      color: #6b7280;
    }

    .summary-wrap {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .summary-pill {
      background: #f3f4f6;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .summary-pill span.key {
      color: #4b5563;
    }

    .summary-pill span.val {
      font-weight: 600;
    }

    .table-wrapper {
      margin-top: 6px;
      max-height: 360px;
      overflow: auto;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 12px;
      min-width: 600px;
    }

    thead {
      position: sticky;
      top: 0;
      background: #f9fafb;
      z-index: 1;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-weight: 600;
      color: #4b5563;
      font-size: 11px;
    }

    tr:nth-child(even) td {
      background: #f9fafb;
    }

    .tag-win {
      color: #16a34a;
      font-weight: 700;
    }

    .tag-lose {
      color: #ef4444;
      font-weight: 700;
    }

    .tag-draw {
      color: #6b7280;
      font-weight: 700;
    }

    .tag-order {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eef2ff;
      color: #3730a3;
    }

    .tag-type {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #fee2e2;
      color: #b91c1c;
    }

    .delete-btn {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: none;
      background: #fee2e2;
      color: #991b1b;
      cursor: pointer;
    }

    /* 統計用の棒グラフ風（CSS） */

    .stats-row {
      margin-bottom: 8px;
    }

    .stats-row-header {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-bottom: 2px;
    }

    .stats-label {
      font-weight: 500;
    }

    .stats-summary {
      color: #4b5563;
    }

    .stats-bar-wrapper {
      position: relative;
      height: 10px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
    }

    .stats-bar-fill {
      height: 100%;
      background: #3b82f6;
      border-radius: 999px;
    }

    .stats-bar-percent {
      margin-top: 2px;
      font-size: 10px;
      color: #374151;
      text-align: right;
    }

    /* backup area */
    .backup-textarea {
      width: 100%;
      min-height: 90px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      padding: 6px 8px;
      font-size: 11px;
      font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      box-sizing: border-box;
    }

    .backup-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }
  </style>
</head>
<body>
<header>
  <div>
    ポケポケ 勝敗記録
    <div class="subtitle">勝率・スランプ・先行/後攻・時間帯までまとめて見える化</div>
  </div>
  <div style="font-size: 11px;">ver. 日付＆時間統計入り</div>
</header>

<main>
  <div class="grid">
    <!-- 左側：入力＆サマリー -->
    <section class="card">
      <h2>対戦を記録する <span class="badge">NEW</span></h2>
      <p class="desc">対戦が終わったらサクッと入力。時間は「登録した瞬間」が自動で記録されます。</p>

      <div class="form-row">
        <label for="date-input">日付</label>
        <input id="date-input" type="date">
      </div>

      <div class="form-row">
        <label for="mydeck-input">自分のデッキ名</label>
        <input id="mydeck-input" type="text" placeholder="例: メガバシャーモex">
      </div>

      <div class="form-row">
        <label for="opponentdeck-input">相手のデッキ名</label>
        <input id="opponentdeck-input" type="text" placeholder="例: スイクンex">
      </div>

      <div class="form-row">
        <label>タイプ</label>
        <div class="inline-options">
          <div class="inline-option">
            <select id="type-input">
              <option value="">自分</option>
              <option value="fire">炎</option>
              <option value="water">水</option>
              <option value="grass">草</option>
              <option value="lightning">雷</option>
              <option value="psychic">超</option>
              <option value="dark">悪</option>
              <option value="dragon">ドラゴン</option>
              <option value="colorless">無色</option>
            </select>
          </div>
          <div class="inline-option">
            <select id="opponenttype-input">
              <option value="">相手</option>
              <option value="fire">炎</option>
              <option value="water">水</option>
              <option value="grass">草</option>
              <option value="lightning">雷</option>
              <option value="psychic">超</option>
              <option value="dark">悪</option>
              <option value="dragon">ドラゴン</option>
              <option value="colorless">無色</option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-row">
        <label>結果</label>
        <div class="inline-options">
          <label class="inline-option">
            <input type="radio" name="result" value="win" checked> 勝ち
          </label>
          <label class="inline-option">
            <input type="radio" name="result" value="lose"> 負け
          </label>
          <label class="inline-option">
            <input type="radio" name="result" value="draw"> 引き分け
          </label>
        </div>
      </div>

      <div class="form-row">
        <label>先行 / 後攻</label>
        <div class="inline-options">
          <label class="inline-option">
            <input type="radio" name="order" value="first" checked> 先行
          </label>
          <label class="inline-option">
            <input type="radio" name="order" value="second"> 後攻
          </label>
        </div>
      </div>

      <div class="form-row">
        <label for="memo-input">メモ（任意）</label>
        <textarea id="memo-input" placeholder="例: 事故・相手の事故・感想など"></textarea>
      </div>

      <div class="form-row">
        <button id="add-match-button">この対戦を保存</button>
      </div>

      <hr style="margin: 10px 0; border: none; border-top: 1px dashed #e5e7eb;">

      <h2>全体サマリー</h2>
      <div id="overall-summary">
        <!-- JSで埋める -->
      </div>
    </section>

    <!-- 右側：スランプ & バックアップ -->
    <section class="card">
      <h2>スランプグラフ</h2>
      <p class="desc">勝ちで +1、負けで -1、引き分け 0 とした「累積」のグラフです。</p>
      <canvas id="slump-chart" height="180"></canvas>

      <hr style="margin: 10px 0; border: none; border-top: 1px dashed #e5e7eb;">

      <h2>バックアップ / 復元</h2>
      <p class="desc">
        「コピー」してメモ帳などに保存しておけば、いつでも復元できます。<br>
        JSON を貼り付けて「復元する」を押すと、現在のデータは上書きされます。
      </p>
      <textarea id="backup-textarea" class="backup-textarea" placeholder="ここにJSONを貼り付け / ここからコピー"></textarea>
      <div class="backup-actions">
        <button id="backup-copy-button" class="secondary">今のデータをコピー</button>
        <button id="backup-restore-button" class="danger">貼り付けたJSONで復元する</button>
        <button id="backup-clear-button" class="secondary">全データを削除</button>
      </div>
      <div id="backup-message" style="margin-top: 4px; font-size: 11px; color: #6b7280;"></div>
    </section>
  </div>

  <!-- 2段目：統計 -->
  <section class="card" style="margin-top: 12px;">
    <h2>日付ごとの勝率</h2>
    <p class="desc">1日ごとの勝率（勝ち/負けのみで計算。引き分けは除外）</p>
    <div id="daily-winrate-container"></div>
  </section>

  <section class="card" style="margin-top: 12px;">
    <h2>時間帯ごとの勝率</h2>
    <p class="desc">0〜23時ごとの勝率（保存した時間を元に集計）</p>
    <div id="hourly-winrate-container"></div>
  </section>

  <section class="card" style="margin-top: 12px;">
    <h2>先行 / 後攻 の試合数と勝率</h2>
    <p class="desc">先行・後攻で何試合して、どれくらい勝っているかを表示します。</p>
    <div id="order-summary-container"></div>
  </section>

  <!-- 対戦一覧 -->
  <section class="card" style="margin-top: 12px;">
    <h2>対戦履歴</h2>
    <p class="desc">最新の対戦が上に表示されます。時間は自動記録されたものです。</p>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>日付</th>
            <th>時間</th>
            <th>結果</th>
            <th>先行/後攻</th>
            <th>自分デッキ</th>
            <th>相手デッキ</th>
            <th>タイプ</th>
            <th>メモ</th>
            <th>削除</th>
          </tr>
        </thead>
        <tbody id="match-list-body">
          <!-- JSで埋める -->
        </tbody>
      </table>
    </div>
  </section>
</main>

<script>
  // ====== データ保存まわり ======
  const STORAGE_KEY = "pokepoke_matches_v1";

  /** @type {Array} */
  let matches = [];

  function loadMatches() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        matches = [];
      } else {
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) {
          matches = parsed;
        } else {
          matches = [];
        }
      }
    } catch (e) {
      console.error("load error", e);
      matches = [];
    }
  }

  function saveMatches() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(matches));
    } catch (e) {
      console.error("save error", e);
    }
  }

  // ====== 共通ユーティリティ ======

  function formatTimeFromId(id) {
    if (!id) return "";
    const d = new Date(id);
    if (isNaN(d.getTime())) return "";
    const h = d.getHours().toString().padStart(2, "0");
    const m = d.getMinutes().toString().padStart(2, "0");
    return `${h}:${m}`;
  }

  function calcWinRate(win, lose) {
    const total = win + lose;
    if (!total) return 0;
    return (win / total) * 100;
  }

  // ====== UI描画 ======

  function renderOverallSummary() {
    const el = document.getElementById("overall-summary");
    if (!el) return;

    const total = matches.length;
    let win = 0, lose = 0, draw = 0;
    matches.forEach(m => {
      if (m.result === "win") win++;
      else if (m.result === "lose") lose++;
      else draw++;
    });

    const wlTotal = win + lose;
    const winRate = wlTotal ? (win / wlTotal) * 100 : 0;

    const orderStats = calcOrderStats(matches);

    el.innerHTML = "";

    const big = document.createElement("div");
    big.className = "summary-highlight";
    big.textContent = `${winRate.toFixed(1)}%`;
    el.appendChild(big);

    const sub = document.createElement("div");
    sub.className = "summary-sub";
    sub.textContent = `勝率（勝ち/負けのみ）`;
    el.appendChild(sub);

    const row1 = document.createElement("div");
    row1.className = "summary-row";
    row1.innerHTML =
      `<div class="summary-label">総試合数</div><div class="summary-value">${total}戦</div>`;
    el.appendChild(row1);

    const row2 = document.createElement("div");
    row2.className = "summary-row";
    row2.innerHTML =
      `<div class="summary-label">内訳</div><div class="summary-value">勝 ${win} / 負 ${lose} / 分 ${draw}</div>`;
    el.appendChild(row2);

    const wrap = document.createElement("div");
    wrap.className = "summary-wrap";

    ["first", "second"].forEach(key => {
      const st = orderStats[key];
      const totalOrder = st.win + st.lose + st.draw;
      const rate = calcWinRate(st.win, st.lose);

      const pill = document.createElement("div");
      pill.className = "summary-pill";
      pill.innerHTML =
        `<span class="key">${st.label}</span>` +
        `<span class="val">${totalOrder}戦 / 勝率 ${rate.toFixed(1)}%</span>`;
      wrap.appendChild(pill);
    });

    el.appendChild(wrap);
  }

  let slumpChart = null;

  function renderSlumpChart() {
    const ctx = document.getElementById("slump-chart");
    if (!ctx) return;

    // 並び替え（古い順）
    const sorted = [...matches].sort((a, b) => (a.id || 0) - (b.id || 0));

    const labels = [];
    const data = [];
    let current = 0;
    sorted.forEach((m, idx) => {
      if (m.result === "win") current += 1;
      else if (m.result === "lose") current -= 1;
      // drawは0

      labels.push(`#${idx + 1}`);
      data.push(current);
    });

    if (slumpChart) {
      slumpChart.destroy();
      slumpChart = null;
    }

    if (!sorted.length) {
      // データなしなら空グラフで終了
      slumpChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [{
            label: "スランプ",
            data: [],
          }]
        },
        options: {
          plugins: { legend: { display: false } }
        }
      });
      return;
    }

    slumpChart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: "スランプ",
          data,
          tension: 0.3,
          borderWidth: 2,
          pointRadius: 0,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: {
            ticks: {
              maxTicksLimit: 8
            }
          }
        }
      }
    });
  }

  // ====== 統計（CSSバー） ======

  function groupByDate(matches) {
    const map = new Map();
    matches.forEach(m => {
      const date = m.date;
      if (!date) return;
      if (!map.has(date)) {
        map.set(date, { date, win: 0, lose: 0, draw: 0 });
      }
      const row = map.get(date);
      if (m.result === "win") row.win++;
      else if (m.result === "lose") row.lose++;
      else row.draw++;
    });
    return Array.from(map.values()).sort((a, b) => a.date.localeCompare(b.date));
  }

  function groupByHour(matches) {
    const map = new Map();
    matches.forEach(m => {
      if (!m.id) return;
      const d = new Date(m.id);
      if (isNaN(d.getTime())) return;
      const hour = d.getHours();

      if (!map.has(hour)) {
        map.set(hour, { hour, win: 0, lose: 0, draw: 0 });
      }
      const row = map.get(hour);
      if (m.result === "win") row.win++;
      else if (m.result === "lose") row.lose++;
      else row.draw++;
    });
    return Array.from(map.values()).sort((a, b) => a.hour - b.hour);
  }

  function calcOrderStats(matches) {
    const res = {
      first: { label: "先行", win: 0, lose: 0, draw: 0 },
      second: { label: "後攻", win: 0, lose: 0, draw: 0 }
    };
    matches.forEach(m => {
      const o = m.order;
      if (!o || !res[o]) return;
      if (m.result === "win") res[o].win++;
      else if (m.result === "lose") res[o].lose++;
      else res[o].draw++;
    });
    return res;
  }

  function createStatsRow(labelText, summaryText, winRate) {
    const row = document.createElement("div");
    row.className = "stats-row";

    const header = document.createElement("div");
    header.className = "stats-row-header";

    const label = document.createElement("div");
    label.className = "stats-label";
    label.textContent = labelText;

    const summary = document.createElement("div");
    summary.className = "stats-summary";
    summary.textContent = summaryText;

    header.appendChild(label);
    header.appendChild(summary);

    const barWrapper = document.createElement("div");
    barWrapper.className = "stats-bar-wrapper";

    const barFill = document.createElement("div");
    barFill.className = "stats-bar-fill";
    const safeRate = Math.max(0, Math.min(100, winRate));
    barFill.style.width = safeRate.toFixed(1) + "%";

    barWrapper.appendChild(barFill);

    const percent = document.createElement("div");
    percent.className = "stats-bar-percent";
    percent.textContent = safeRate.toFixed(1) + "%";

    row.appendChild(header);
    row.appendChild(barWrapper);
    row.appendChild(percent);

    return row;
  }

  function renderDailyWinrate(matches) {
    const container = document.getElementById("daily-winrate-container");
    if (!container) return;
    container.innerHTML = "";

    const list = groupByDate(matches);
    if (!list.length) {
      container.textContent = "まだデータがありません。対戦を記録してください。";
      return;
    }

    list.forEach(row => {
      const total = row.win + row.lose + row.draw;
      const rate = calcWinRate(row.win, row.lose);
      const summary =
        `${total}戦｜勝${row.win} / 負${row.lose}` +
        (row.draw ? ` / 分${row.draw}` : "");

      const el = createStatsRow(row.date, summary, rate);
      container.appendChild(el);
    });
  }

  function renderHourlyWinrate(matches) {
    const container = document.getElementById("hourly-winrate-container");
    if (!container) return;
    container.innerHTML = "";

    const list = groupByHour(matches);
    if (!list.length) {
      container.textContent = "まだデータがありません。対戦を記録してください。";
      return;
    }

    list.forEach(row => {
      const total = row.win + row.lose + row.draw;
      const rate = calcWinRate(row.win, row.lose);
      const label = `${row.hour}時台`;
      const summary =
        `${total}戦｜勝${row.win} / 負${row.lose}` +
        (row.draw ? ` / 分${row.draw}` : "");

      const el = createStatsRow(label, summary, rate);
      container.appendChild(el);
    });
  }

  function renderOrderSummary(matches) {
    const container = document.getElementById("order-summary-container");
    if (!container) return;
    container.innerHTML = "";

    const stats = calcOrderStats(matches);
    ["first", "second"].forEach(key => {
      const row = stats[key];
      const total = row.win + row.lose + row.draw;
      const rate = calcWinRate(row.win, row.lose);
      const label = row.label;
      const summary =
        `${total}戦｜勝${row.win} / 負${row.lose}` +
        (row.draw ? ` / 分${row.draw}` : "");

      const el = createStatsRow(label, summary, rate);
      container.appendChild(el);
    });
  }

  // ====== 対戦一覧 ======

  function renderMatchList() {
    const tbody = document.getElementById("match-list-body");
    if (!tbody) return;
    tbody.innerHTML = "";

    // 新しい順に
    const sorted = [...matches].sort((a, b) => (b.id || 0) - (a.id || 0));

    sorted.forEach((m, index) => {
      const tr = document.createElement("tr");

      const battleNumber = m.battleNumber || (sorted.length - index);

      const tdIdx = document.createElement("td");
      tdIdx.textContent = battleNumber;
      tr.appendChild(tdIdx);

      const tdDate = document.createElement("td");
      tdDate.textContent = m.date || "";
      tr.appendChild(tdDate);

      const tdTime = document.createElement("td");
      tdTime.textContent = formatTimeFromId(m.id);
      tr.appendChild(tdTime);

      const tdResult = document.createElement("td");
      const spanRes = document.createElement("span");
      if (m.result === "win") {
        spanRes.textContent = "勝ち";
        spanRes.className = "tag-win";
      } else if (m.result === "lose") {
        spanRes.textContent = "負け";
        spanRes.className = "tag-lose";
      } else {
        spanRes.textContent = "分";
        spanRes.className = "tag-draw";
      }
      tdResult.appendChild(spanRes);
      tr.appendChild(tdResult);

      const tdOrder = document.createElement("td");
      const spanOrder = document.createElement("span");
      spanOrder.className = "tag-order";
      spanOrder.textContent = m.order === "first" ? "先行" : "後攻";
      tdOrder.appendChild(spanOrder);
      tr.appendChild(tdOrder);

      const tdMy = document.createElement("td");
      tdMy.textContent = m.myDeck || "";
      tr.appendChild(tdMy);

      const tdOp = document.createElement("td");
      tdOp.textContent = m.opponentDeck || "";
      tr.appendChild(tdOp);

      const tdType = document.createElement("td");
      const typeParts = [];
      if (m.type) typeParts.push("自:" + m.type);
      if (m.opponentType) typeParts.push("相:" + m.opponentType);
      tdType.textContent = typeParts.join(" / ");
      tr.appendChild(tdType);

      const tdMemo = document.createElement("td");
      tdMemo.textContent = m.memo || "";
      tr.appendChild(tdMemo);

      const tdDel = document.createElement("td");
      const btnDel = document.createElement("button");
      btnDel.className = "delete-btn";
      btnDel.textContent = "削除";
      btnDel.addEventListener("click", () => {
        if (!confirm("この対戦を削除しますか？")) return;
        matches = matches.filter(x => x.id !== m.id);
        saveMatches();
        renderAll();
      });
      tdDel.appendChild(btnDel);
      tr.appendChild(tdDel);

      tbody.appendChild(tr);
    });
  }

  // ====== バックアップ ======

  function updateBackupTextarea() {
    const textarea = document.getElementById("backup-textarea");
    if (!textarea) return;
    textarea.value = JSON.stringify(matches, null, 2);
  }

  function showBackupMessage(msg, isError) {
    const el = document.getElementById("backup-message");
    if (!el) return;
    el.textContent = msg;
    el.style.color = isError ? "#b91c1c" : "#4b5563";
  }

  // ====== メイン描画 ======

  function renderAll() {
    renderOverallSummary();
    renderSlumpChart();
    renderDailyWinrate(matches);
    renderHourlyWinrate(matches);
    renderOrderSummary(matches);
    renderMatchList();
    updateBackupTextarea();
  }

  // ====== 初期化 ======

  document.addEventListener("DOMContentLoaded", () => {
    // 日付初期値：今日
    const dateInput = document.getElementById("date-input");
    const todayStr = new Date().toISOString().slice(0, 10);
    if (dateInput) {
      dateInput.value = todayStr;
    }

    loadMatches();
    renderAll();

    const addBtn = document.getElementById("add-match-button");
    addBtn?.addEventListener("click", () => {
      const dateInput = document.getElementById("date-input");
      const myDeckInput = document.getElementById("mydeck-input");
      const opponentDeckInput = document.getElementById("opponentdeck-input");
      const typeInput = document.getElementById("type-input");
      const opponentTypeInput = document.getElementById("opponenttype-input");
      const memoInput = document.getElementById("memo-input");

      const date = dateInput.value || todayStr;
      const myDeck = myDeckInput.value.trim();
      const opponentDeck = opponentDeckInput.value.trim();
      const type = typeInput.value;
      const opponentType = opponentTypeInput.value;
      const result = document.querySelector('input[name="result"]:checked')?.value || "win";
      const order = document.querySelector('input[name="order"]:checked')?.value || "first";

      const id = Date.now();
      const battleNumber = (matches[matches.length - 1]?.battleNumber || matches.length) + 1;

      const match = {
        id,
        date,
        myDeck,
        opponentDeck,
        type,
        opponentType,
        result,
        order,
        memo: memoInput.value.trim(),
        battleNumber
      };

      matches.push(match);
      saveMatches();
      renderAll();

      // フォーム軽くリセット（デッキ名はそのまま残してもOKなら残してもよい）
      memoInput.value = "";
    });

    const copyBtn = document.getElementById("backup-copy-button");
    copyBtn?.addEventListener("click", async () => {
      const textarea = document.getElementById("backup-textarea");
      textarea.select();
      try {
        await navigator.clipboard.writeText(textarea.value);
        showBackupMessage("クリップボードにコピーしました。", false);
      } catch (e) {
        showBackupMessage("コピーに失敗しました…。手動でコピーしてください。", true);
      }
    });

    const restoreBtn = document.getElementById("backup-restore-button");
    restoreBtn?.addEventListener("click", () => {
      const textarea = document.getElementById("backup-textarea");
      if (!textarea.value.trim()) {
        showBackupMessage("JSONが空です。貼り付けてから実行してください。", true);
        return;
      }
      if (!confirm("貼り付けられたJSONでデータを上書きします。よろしいですか？")) return;

      try {
        const parsed = JSON.parse(textarea.value);
        if (!Array.isArray(parsed)) throw new Error("配列ではありません");
        matches = parsed;
        saveMatches();
        renderAll();
        showBackupMessage("復元しました。", false);
      } catch (e) {
        console.error(e);
        showBackupMessage("JSONの形式がおかしいようです。", true);
      }
    });

    const clearBtn = document.getElementById("backup-clear-button");
    clearBtn?.addEventListener("click", () => {
      if (!confirm("本当に全データを削除しますか？")) return;
      matches = [];
      saveMatches();
      renderAll();
      showBackupMessage("全データを削除しました。", false);
    });
  });
</script>
</body>
</html>
